{% extends "shop/base.html" %}
{% load static %}
{% block title %}Chi ti·∫øt ƒë∆°n h√†ng{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{% url 'shop:my_orders_page' %}" class="btn btn-sm btn-outline-secondary">‚Üê Quay l·∫°i danh s√°ch</a>

    <div class="d-flex gap-2">
      <button id="btn-print" class="btn btn-sm btn-outline-primary">In</button>
      {% if order.trang_thai == 'cho_xu_ly' or order.trang_thai == 'da_xac_nhan' %}
      <button id="btn-cancel" class="btn btn-sm btn-danger">H·ªßy ƒë∆°n</button>
      {% endif %}
    </div>
  </div>

  <div class="card shadow-sm border-0 rounded-4 p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
      <div>
        <h4 class="text-success mb-2">Chi ti·∫øt ƒë∆°n h√†ng</h4>
        <div class="text-muted">M√£ ƒë∆°n: <code>{{ order.id|slice:":8" }}</code></div>
      </div>
      <div class="text-end">
        <div class="mb-1">
          <span class="badge rounded-pill status-badge" data-status="{{ order.trang_thai }}">{{ order.trang_thai }}</span>
        </div>
        <div class="small text-muted">
          Ng√†y t·∫°o: <span class="time" data-iso="{{ order.ngay_tao }}">{{ order.ngay_tao }}</span>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <div class="p-3 rounded-3 border bg-light">
          <div class="small text-muted">Ph∆∞∆°ng th·ª©c thanh to√°n</div>
          <div class="fw-semibold mt-1">{{ order.phuong_thuc_thanh_toan|upper }}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="p-3 rounded-3 border bg-light">
          <div class="small text-muted">T·ªïng ti·ªÅn</div>
          <div class="fw-bold mt-1 h5 mb-0">
            <span class="money" data-v="{{ order.tong_tien }}">{{ order.tong_tien }}</span> ƒë
          </div>
        </div>
      </div>
    </div>

    {% if order.nguoi_dat %}
    <div class="p-3 rounded-3 border mb-3">
      <div class="small text-muted">Th√¥ng tin ƒë·∫∑t h√†ng</div>
      <div class="row mt-1">
        <div class="col-md-6">
          <div><strong>H·ªç t√™n:</strong> {{ order.nguoi_dat.ten|default:"‚Äî" }}</div>
          {% if order.nguoi_dat.ghi_chu %}
          <div class="mt-2"><strong>Ghi ch√∫:</strong> {{ order.nguoi_dat.ghi_chu }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <div><strong>SƒêT:</strong> {{ order.nguoi_dat.sdt|default:"‚Äî" }}</div>
          <div><strong>ƒê·ªãa ch·ªâ:</strong> {{ order.nguoi_dat.dia_chi|default:"‚Äî" }}</div>
        </div>
      </div>
    </div>
    {% endif %}

    <h6 class="text-secondary mb-2">Danh s√°ch s·∫£n ph·∫©m</h6>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>T√™n s·∫£n ph·∫©m</th>
            <th class="text-center" style="width:110px">S·ªë l∆∞·ª£ng</th>
            <th class="text-end" style="width:160px">ƒê∆°n gi√°</th>
            <th class="text-end" style="width:180px">Th√†nh ti·ªÅn</th>
          </tr>
        </thead>
        <tbody>
          {% if order.items %}
            {% for it in order.items %}
            <tr>
              <td>{{ it.san_pham_ten|default:"(Kh√¥ng r√µ)" }}</td>
              <td class="text-center">{{ it.so_luong }}</td>
              <td class="text-end"><span class="money" data-v="{{ it.don_gia }}">{{ it.don_gia }}</span> ƒë</td>
              <td class="text-end"><span class="money" data-v="{{ it.tong_tien }}">{{ it.tong_tien }}</span> ƒë</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td>{{ order.san_pham_ten|default:"(Kh√¥ng r√µ)" }}</td>
              <td class="text-center">{{ order.so_luong|default:1 }}</td>
              <td class="text-end"><span class="money" data-v="{{ order.don_gia|default:0 }}">{{ order.don_gia|default:0 }}</span> ƒë</td>
              <td class="text-end"><span class="money" data-v="{{ order.tong_tien|default:0 }}">{{ order.tong_tien|default:0 }}</span> ƒë</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .status-badge { text-transform: none; }
  .st-cho_xu_ly   { background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }
  .st-da_xac_nhan { background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; }
  .st-dang_giao   { background:#f0f9ff; color:#0369a1; border:1px solid #bae6fd; }
  .st-hoan_thanh  { background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; }
  .st-da_huy      { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
  #btn-print, #btn-cancel { border-radius: 999px; }
</style>

<script>
  function vnd(n){ try { return Number(n).toLocaleString('vi-VN'); } catch { return n; } }
  function fmtTime(iso){
    if(!iso) return '‚Äî';
    try {
      const d = new Date(iso);
      const dd = d.toLocaleDateString('vi-VN');
      const hh = d.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
      return `${dd} ${hh}`;
    } catch { return iso; }
  }
  function mapStatusText(st){
  const m={
    'cho_xu_ly':'Ch·ªù x·ª≠ l√Ω',
    'da_xac_nhan':'ƒê√£ x√°c nh·∫≠n',
    'dang_giao':'ƒêang giao',
    'hoan_thanh':'Ho√†n th√†nh',
    'huy':'ƒê√£ h·ªßy'  // üëà th√™m key 'huy'
  };
  return m[st]||st;
}


  // Format
  document.querySelectorAll('.money').forEach(el=>el.textContent=vnd(el.dataset.v||el.textContent));
  document.querySelectorAll('.time').forEach(el=>el.textContent=fmtTime(el.dataset.iso||el.textContent));
  document.querySelectorAll('.status-badge').forEach(el=>{
    const st=(el.dataset.status||'').trim();
    el.textContent = mapStatusText(st);
    el.classList.add('st-'+st);
  });

  // In
  document.getElementById('btn-print')?.addEventListener('click', ()=> window.print());

  // ‚öôÔ∏è H·ªßy ƒë∆°n
  const cancelBtn = document.getElementById('btn-cancel');
  if (cancelBtn) {
    const CANCEL_URL = `/api/my-orders/{{ order.id }}/cancel/`;
    cancelBtn.addEventListener('click', async () => {
      if (!confirm('B·∫°n ch·∫Øc mu·ªën h·ªßy ƒë∆°n n√†y?')) return;
      try {
        const r = await fetch(CANCEL_URL, {
          method: 'DELETE',   // ‚úÖ ƒë·ªïi t·ª´ POST -> DELETE
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await r.json().catch(()=>({}));
        if (!r.ok || !data.ok) {
          alert('H·ªßy th·∫•t b·∫°i' + (data.error ? `: ${data.error}` : ''));
          return;
        }
        alert('ƒê√£ h·ªßy ƒë∆°n th√†nh c√¥ng!');
        location.reload();
      } catch (e) {
        alert('C√≥ l·ªói m·∫°ng, vui l√≤ng th·ª≠ l·∫°i!');
      }
    });
  }
</script>

{% endblock %}
