{% extends "shop/base.html" %}
{% load static %}

{% block title %}Đơn hàng của tôi{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Header -->
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <h3 class="mb-2 mb-sm-0">
      Đơn hàng của tôi
      <span id="paid-badge" class="badge rounded-pill ms-1">{{ items|length }}</span>
    </h3>

    <div class="d-flex align-items-center gap-2">
      <a href="{% url 'shop:home' %}" class="btn btn-sm btn-outline-secondary">
        ← Tiếp tục mua sắm
      </a>
    </div>
  </div>

  {% if not items %}
    <div class="alert alert-info shadow-sm rounded-3">
      Bạn chưa có đơn nào.
      <a href="{% url 'shop:home' %}" class="alert-link">Mua ngay</a> nhé!
    </div>
  {% else %}
    <div class="card shadow-sm border-0 rounded-4">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Mã đơn</th>
              <th>Sản phẩm</th>
              <th class="text-end">Tổng tiền</th>
              <th>Thanh toán</th>
              <th>Trạng thái / Ngày tạo</th>
              <th style="width:180px" class="text-end">Thao tác</th>
            </tr>
          </thead>
          <tbody>
            {% for o in items %}
              {% with has_multi=o.items|default:None %}
              <tr>
                <td><code class="text-muted">{{ o.id|slice:":8" }}</code></td>

                <td>
                  {% if has_multi %}
                    {% firstof o.items.0.san_pham_ten "(Chưa rõ tên)" as first_name %}
                    <div class="fw-semibold">{{ first_name }}</div>
                    <div class="small text-muted">
                      Số lượng: {{ o.items.0.so_luong|default:1 }}
                      {% if o.items|length > 1 %} • +{{ o.items|length|add:"-1" }} sản phẩm khác{% endif %}
                    </div>

                    {% if o.items|length > 1 %}
                      <details class="mt-1">
                        <summary class="small text-primary">Xem chi tiết</summary>
                        <ul class="small mb-0 mt-1">
                          {% for it in o.items %}
                            <li>
                              {% firstof it.san_pham_ten "(Chưa rõ tên)" %} — SL: {{ it.so_luong }} — 
                              <span class="money" data-v="{{ it.tong_tien|default:0 }}">{{ it.tong_tien|default:0 }}</span> đ
                            </li>
                          {% endfor %}
                        </ul>
                      </details>
                    {% endif %}
                  {% else %}
                    <div class="fw-semibold">{{ o.san_pham_ten|default:"(Không rõ sản phẩm)" }}</div>
                    <div class="small text-muted">Số lượng: {{ o.so_luong|default:1 }}</div>
                  {% endif %}
                </td>

                <td class="text-end fw-semibold">
                  <span class="money" data-v="{{ o.tong_tien|default:0 }}">{{ o.tong_tien|default:0 }}</span> đ
                </td>

                <td><span class="badge rounded-pill bg-light text-dark border">{{ o.phuong_thuc_thanh_toan|upper }}</span></td>

                <td>
                  <div>
                    <span class="badge rounded-pill status-badge" data-status="{{ o.trang_thai|default:'cho_xu_ly' }}">
                      {{ o.trang_thai|default:"cho_xu_ly" }}
                    </span>
                  </div>
                  <div class="small text-muted mt-1">
                    <span class="time" data-iso="{{ o.ngay_tao }}">{{ o.ngay_tao }}</span>
                  </div>
                </td>

                <td class="text-end">
                  <div class="d-flex gap-2 justify-content-end">
                    <a href="{% url 'shop:order_detail' o.id %}" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-eye"></i> Chi tiết
                    </a>
                    {% if o.trang_thai == 'cho_xu_ly' or o.trang_thai == 'da_xac_nhan' %}
                      <button data-id="{{ o.id }}" class="btn btn-sm btn-outline-danger btn-cancel-order">
                        <i class="bi bi-x-circle"></i> Hủy
                      </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}
</div>

<style>
  h3 { color: #0f766e; }
  .badge#paid-badge { background: #e8f7f2; color: #0f766e; border: 1px solid #bfe9de; }
  .card { border-radius: 1rem !important; }
  .table thead th { white-space: nowrap; }
  .status-badge { text-transform: none; }
  .st-cho_xu_ly   { background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }
  .st-da_xac_nhan { background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; }
  .st-dang_giao   { background:#f0f9ff; color:#0369a1; border:1px solid #bae6fd; }
  .st-hoan_thanh  { background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; }
  .st-huy         { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }

  .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
    transition: all 0.2s ease-in-out;
  }
  .btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(220,53,69,0.3);
  }
  .btn-outline-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(13,110,253,0.3);
  }
  details > summary { cursor: pointer; }
</style>

<script>
  // ---- Helpers ----
  function vnd(n){try{return Number(n).toLocaleString('vi-VN')}catch{return n}}
  function fmtTime(iso){
    if(!iso) return '—';
    try{
      const d=new Date(iso);
      const dd=d.toLocaleDateString('vi-VN');
      const hh=d.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
      return `${dd} ${hh}`;
    }catch{return iso}
  }
  function mapStatusText(st){
    const m={'cho_xu_ly':'Chờ xử lý','da_xac_nhan':'Đã xác nhận','dang_giao':'Đang giao','hoan_thanh':'Hoàn thành','huy':'Đã hủy'};
    return m[st]||st;
  }

  // ---- Định dạng tiền & thời gian ----
  document.querySelectorAll('.money').forEach(el=>{el.textContent=vnd(el.dataset.v||el.textContent)});
  document.querySelectorAll('.time').forEach(el=>{el.textContent=fmtTime(el.dataset.iso||el.textContent)});
  document.querySelectorAll('.status-badge').forEach(el=>{
    const st=(el.dataset.status||'').trim();
    el.textContent=mapStatusText(st);
    el.classList.add('st-'+st);
  });

  // ---- Hủy đơn trực tiếp ----
  document.querySelectorAll('.btn-cancel-order').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!confirm('Bạn có chắc muốn hủy đơn này?')) return;
      const id = btn.dataset.id;
      try{
        const r = await fetch(`/api/my-orders/${id}/cancel/`, { method: 'POST', credentials: 'same-origin' });
        if(r.ok){
          alert('Đã hủy đơn thành công!');
          location.reload();
        }else{
          const d = await r.json().catch(()=>({}));
          alert('Hủy thất bại' + (d.error ? `: ${d.error}` : ''));
        }
      }catch(e){
        alert('Lỗi mạng, vui lòng thử lại!');
      }
    });
  });

  // ---- Cập nhật badge đếm (tất cả đơn, không lọc paid) ----
  (async function(){
    try{
      const url=new URL('/api/my-orders/count/', window.location.origin);
      url.searchParams.set('paid', '0');
      const r=await fetch(url,{credentials:'same-origin'});
      if(!r.ok) return;
      const {count}=await r.json();
      const bd=document.getElementById('paid-badge');
      if(bd){
        if(count>0){
          bd.textContent=count;
          bd.style.display='inline-block';
        }else{
          bd.style.display='none';
        }
      }
    }catch{}
  })();
</script>
{% endblock %}
