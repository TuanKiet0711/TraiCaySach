{% extends "shop/base.html" %}
{% block title %}ƒêƒÉng k√Ω | Tr√°i C√¢y S·∫°ch{% endblock %}
{% block content %}
<div class="auth-wrapper">
  <div class="auth-card">
    <h1>T·∫°o t√†i kho·∫£n</h1>
    <p class="sub">Nh·∫≠n ∆∞u ƒë√£i m·ªói tu·∫ßn & ƒë·∫∑t tr√°i c√¢y t∆∞∆°i nhanh ch√≥ng üçè</p>

    <form id="registerForm">
      {% csrf_token %}
      <div class="form-group">
        <label for="ho_ten">H·ªç t√™n *</label>
        <input id="ho_ten" name="ho_ten" placeholder="Nguy·ªÖn VƒÉn A" required />
      </div>

      <div class="form-group">
        <label for="email">Email *</label>
        <input id="email" name="email" type="email" placeholder="nhapemail@domain.com" required />
      </div>

      <div class="form-group">
        <label for="sdt">S·ªë ƒëi·ªán tho·∫°i</label>
        <input id="sdt" name="sdt" placeholder="09xxxxxxxx" />
      </div>

      <div class="form-group">
        <label for="password">M·∫≠t kh·∫©u *</label>
        <div class="password-row">
          <input id="password" name="password" type="password" placeholder="√çt nh·∫•t 6 k√Ω t·ª±" minlength="6" required />
          <button class="ghost" type="button" id="togglePwd">Hi·ªán</button>
        </div>
      </div>

      <input type="hidden" id="nextUrl" value="{{ next_url|default:'/' }}"/>

      <button id="btnRegister" type="submit" class="primary w-100">ƒêƒÉng k√Ω</button>
      <div id="msg" class="msg" aria-live="polite"></div>
    </form>

    <div class="alt">
      ƒê√£ c√≥ t√†i kho·∫£n?
      <a href="{% url 'shop:shop_login' %}{% if next_url %}?next={{ next_url }}{% endif %}">ƒêƒÉng nh·∫≠p</a>
    </div>
  </div>
</div>

<style>
  .auth-wrapper{display:flex;justify-content:center;align-items:center;min-height:68vh;padding:24px;}
  .auth-card{width:100%;max-width:480px;background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08);padding:28px;}
  h1{margin:0 0 8px;font-size:26px}
  .sub{margin:0 0 18px;color:#666}
  .form-group{margin-bottom:14px}
  label{display:block;margin-bottom:6px;font-weight:600}
  input{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;font-size:14px;outline:none}
  input:focus{border-color:#16a34a; box-shadow:0 0 0 3px rgba(22,163,74,.15)}
  .password-row{display:flex;gap:8px;align-items:center}
  .password-row .ghost{white-space:nowrap;border:none;background:transparent;padding:0 10px;color:#111;cursor:pointer}
  .primary{background:#16a34a;border:none;color:#fff;font-weight:700;padding:12px 16px;border-radius:12px;cursor:pointer}
  .primary:disabled{opacity:.6;cursor:not-allowed}
  .w-100{width:100%}
  .alt{margin-top:14px;text-align:center}
  .alt a{color:#16a34a;font-weight:600}
  .msg{margin-top:10px;font-size:14px;color:#b91c1c}
  .toast{position:fixed;right:14px;top:14px;background:#16a34a;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.12);display:none}
</style>

<div id="toast" class="toast">ƒêƒÉng k√Ω th√†nh c√¥ng!</div>

<script>
  const form = document.getElementById('registerForm');
  const btn  = document.getElementById('btnRegister');
  const msg  = document.getElementById('msg');
  const toast= document.getElementById('toast');
  const btnToggle = document.getElementById('togglePwd');

  btnToggle.addEventListener('click', () => {
    const i = document.getElementById('password');
    const show = i.type === 'password';
    i.type = show ? 'text' : 'password';
    btnToggle.textContent = show ? '·∫®n' : 'Hi·ªán';
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    btn.disabled = true;

    const payload = {
      ho_ten: (document.getElementById('ho_ten').value || '').trim(),
      email : (document.getElementById('email').value || '').trim().toLowerCase(),
      sdt   : (document.getElementById('sdt').value || '').trim(),
      password: (document.getElementById('password').value || '').trim()
    };

    try {
      const res = await fetch('/api/auth/register', {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(payload),
        credentials: 'same-origin'
      });
      const data = await res.json().catch(()=> ({}));

      if (!res.ok) {
        msg.textContent = data?.error || 'ƒêƒÉng k√Ω th·∫•t b·∫°i';
      } else {
        toast.style.display = 'block';
        setTimeout(() => {
          const nextUrl = document.getElementById('nextUrl').value || '/';
          window.location.href = nextUrl;
        }, 600);
      }
    } catch (err) {
      msg.textContent = 'L·ªói m·∫°ng, vui l√≤ng th·ª≠ l·∫°i.';
    } finally {
      btn.disabled = false;
    }
  });
</script>
{% endblock %}
