{% extends "shop/base.html" %}
{% block title %}Đăng nhập - Trái Cây Sạch{% endblock %}
{% block content %}
<style>
.card{border-radius:1rem}
.btn-success{background-color:#198754;border-color:#198754}
.btn-success:hover{background-color:#157347;border-color:#146c43}
</style>

<div class="row justify-content-center">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-sm border-0">
      <div class="card-body p-4">
        <h3 class="text-center mb-4 text-success fw-bold">Đăng nhập</h3>
        <form id="loginForm">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" placeholder="Nhập email" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Mật khẩu</label>
            <input type="password" name="mat_khau" class="form-control" placeholder="Nhập mật khẩu" required>
          </div>
          <button type="submit" class="btn btn-success w-100">Đăng nhập</button>
        </form>
        <div class="text-center mt-3">
          <small>Chưa có tài khoản? <a href="{% url 'shop:shop_register' %}">Đăng ký ngay</a></small>
        </div>
        <div id="loginMsg" class="mt-3 text-center"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const email = f.email.value.trim();
  const mat_khau = f.mat_khau.value.trim();

  const res = await fetch('/api/auth/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({email, mat_khau})
  });

  const msg = document.getElementById('loginMsg');

  if(res.ok){
    const data = await res.json();     // <-- lấy vai_tro
    const role = (data?.user?.vai_tro || 'customer').toLowerCase();

    msg.innerHTML = '<div class="alert alert-success">Đăng nhập thành công</div>';

    // Điều hướng theo vai trò
    const nextUrl = role === 'admin' ? '{% url "shop:admin_dashboard" %}' : '{% url "shop:home" %}';
    setTimeout(()=>{ window.location.href = nextUrl; }, 800);
  } else {
    const data = await res.json().catch(()=>({}));
    msg.innerHTML = '<div class="alert alert-danger">'+(data.error||'Đăng nhập thất bại')+'</div>';
  }
});
</script>
{% endblock %}
