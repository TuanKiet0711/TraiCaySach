{% extends "shop/admin/base_admin.html" %}
{% load humanize %}
{% block title %}Đơn hàng · Admin{% endblock %}
{% block page_title %}Đơn hàng{% endblock %}

{% block content %}
<style>
  html, body {height:100%; overflow:hidden;}
  .admin-fixed {height:calc(100vh - 0px); display:flex; flex-direction:column; overflow:hidden;}
  .toolbar-tight {margin-bottom:.5rem!important;}
  .card-body-tight {padding:.5rem 1rem!important;}
  .table-flex {flex:1 1 auto; min-height:0; overflow:hidden;}

  /* Thanh tìm kiếm */
  .searchbar {--h:38px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
  .searchbar .inputbox {position:relative; flex:1; min-width:280px;}
  .searchbar .inputbox .icon {
    position:absolute; left:12px; top:50%; transform:translateY(-50%);
    opacity:.6; color:#6c757d;
  }
  .searchbar .inputbox input {
    height:var(--h); padding-left:38px; border-radius:12px;
    border:1px solid rgba(0,0,0,.08); box-shadow:0 6px 18px rgba(30,60,120,.06);
  }
  .searchbar select {
    height:var(--h); border-radius:12px; border:1px solid rgba(0,0,0,.08);
    box-shadow:0 6px 18px rgba(30,60,120,.04); min-width:160px;
  }
  .searchbar .btn-find {
    height:var(--h); background:#3b82f6; color:#fff; border:none;
    border-radius:12px; font-weight:600; box-shadow:0 8px 16px rgba(30,60,120,.15);
    transition:transform .08s ease, filter .15s ease;
  }
  .searchbar .btn-find:hover {filter:brightness(1.05); transform:translateY(-1px);}
  .btn-reset {height:var(--h); border-radius:12px;}

  /* Bảng */
  .table th, .table td {vertical-align:middle;}
  .table thead {background:#f9fafb;}
  .table tbody tr:hover {background:#f8faff;}

  /* Badge trạng thái */
  .status-badge {text-transform:none;}
  .st-cho_xu_ly   {background:#fff7ed; color:#9a3412; border:1px solid #fed7aa;}
  .st-da_xac_nhan {background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe;}
  .st-dang_giao   {background:#f0f9ff; color:#0369a1; border:1px solid #bae6fd;}
  .st-hoan_thanh  {background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0;}
  .st-da_huy,
  .st-huy         {background:#fef2f2; color:#991b1b; border:1px solid #fecaca;}

  /* Phân trang dính */
  .pagination-fixed {position:sticky; bottom:0; background:#fff; border-top:1px solid #eee;
    padding:.5rem .75rem; display:flex; align-items:center; justify-content:flex-start;}
  .pagination-fixed .pagination {margin-bottom:0; gap:4px;}
  .pagination-fixed .page-link {
    min-width:34px; height:34px; border:none; border-radius:50%!important;
    color:#333; background:#f8f9fa; box-shadow:0 2px 6px rgba(0,0,0,.05);
    transition:all .15s ease;
  }
  .pagination-fixed .page-link:hover {background:#3b82f6; color:#fff;}
  .pagination-fixed .page-item.active .page-link {
    background:#3b82f6; color:#fff; box-shadow:0 4px 12px rgba(30,60,120,.25);
  }
</style>

<div class="admin-fixed">
  <!-- Thanh tìm kiếm -->
  <div class="d-flex flex-wrap justify-content-between align-items-center toolbar-tight">
    <form method="get" action="" class="searchbar flex-grow-1 me-2">
      <div class="inputbox">
        <i class="bi bi-search icon"></i>
        <input type="text" name="q" value="{{ q|default_if_none:'' }}" class="form-control" placeholder="Tìm theo mã đơn, tài khoản...">
      </div>

      <!-- Bộ lọc trạng thái -->
      <select name="status">
        <option value="">Tất cả trạng thái</option>
        <option value="cho_xu_ly" {% if status == 'cho_xu_ly' %}selected{% endif %}>Chờ xử lý</option>
        <option value="da_xac_nhan" {% if status == 'da_xac_nhan' %}selected{% endif %}>Đã xác nhận</option>
        <option value="dang_giao" {% if status == 'dang_giao' %}selected{% endif %}>Đang giao</option>
        <option value="hoan_thanh" {% if status == 'hoan_thanh' %}selected{% endif %}>Hoàn thành</option>
        <option value="da_huy" {% if status == 'da_huy' %}selected{% endif %}>Đã hủy</option>
      </select>

      <button type="submit" class="btn btn-find"><i class="bi bi-funnel me-1"></i>Tìm</button>
      <a href="{% url 'shop:admin_orders' %}" class="btn btn-light btn-reset"><i class="bi bi-x-circle me-1"></i>Xóa lọc</a>
    </form>
  </div>

  <!-- Bảng -->
  <div class="card shadow-sm border-0 rounded-4 table-flex">
    <div class="card-body card-body-tight">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="width:12%">Mã đơn</th>
              <th style="width:15%">Tài khoản</th>
              <th style="width:20%">Sản phẩm</th>
              <th class="text-center" style="width:8%">SL</th>
              <th class="text-end" style="width:10%">Tổng tiền</th>
              <th style="width:10%">Thanh toán</th>
              <th style="width:10%">Trạng thái</th>
              <th class="text-end" style="width:15%">Hành động</th>
            </tr>
          </thead>
          <tbody>
            {% if items %}
              {% for d in items %}
              <tr>
                <td><code class="small">{{ d.id|slice:":8" }}</code></td>
                <td>{{ d.tai_khoan }}</td>
                <td>{{ d.san_pham }}</td>
                <td class="text-center">{{ d.so_luong }}</td>
                <td class="text-end">{{ d.tong_tien|intcomma }} đ</td>
                <td class="text-uppercase">{{ d.phuong_thuc_thanh_toan|default:"cod" }}</td>
                <td>
                  <span class="badge rounded-pill status-badge st-{{ d.trang_thai }}">{{ d.trang_thai }}</span>
                </td>
                <td class="text-end">
  {% if d.id %}
    <a href="{% url 'shop:admin_order_edit' d.id %}" class="btn btn-sm btn-outline-primary rounded-pill me-1">
      <i class="bi bi-pencil"></i> Sửa
    </a>
    <a href="{% url 'shop:admin_order_delete' d.id %}" class="btn btn-sm btn-outline-danger">
      <i class="bi bi-trash"></i> Xóa
    </a>
  {% else %}
    <button class="btn btn-sm btn-outline-secondary rounded-pill me-1" disabled>
      <i class="bi bi-pencil"></i> Sửa
    </button>
    <button class="btn btn-sm btn-outline-secondary" disabled>
      <i class="bi bi-trash"></i> Xóa
    </button>
  {% endif %}
</td>

              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="8" class="text-center text-muted py-4">Không có đơn hàng</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <!-- Phân trang -->
      <div class="pagination-fixed w-100">
        <div class="me-3 small text-muted">Trang {{ page }} / {{ total_pages }} • Tổng {{ total }} đơn</div>
        <nav>
          <ul class="pagination mb-0">
            <li class="page-item {% if not has_prev %}disabled{% endif %}">
              <a class="page-link" href="?page={{ page|add:'-1' }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status }}{% endif %}">‹</a>
            </li>
            {% for p in page_numbers %}
              {% if p == page %}
              <li class="page-item active"><span class="page-link">{{ p }}</span></li>
              {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ p }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status }}{% endif %}">{{ p }}</a></li>
              {% endif %}
            {% endfor %}
            <li class="page-item {% if not has_next %}disabled{% endif %}">
              <a class="page-link" href="?page={{ page|add:'1' }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status }}{% endif %}">›</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<script>
  // Hiển thị trạng thái tiếng Việt chuẩn
  const mapStatus={
    cho_xu_ly:"Chờ xử lý",
    da_xac_nhan:"Đã xác nhận",
    dang_giao:"Đang giao",
    hoan_thanh:"Hoàn thành",
    da_huy:"Đã hủy",
    huy:"Đã hủy"
  };
  document.querySelectorAll('.status-badge').forEach(el=>{
    const cls=[...el.classList].find(c=>c.startsWith('st-'))||'';
    const st=cls.replace('st-','');
    el.textContent=mapStatus[st]||el.textContent;
  });
</script>
{% endblock %}
