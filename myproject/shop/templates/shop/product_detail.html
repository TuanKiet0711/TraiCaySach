{% extends "shop/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ product.ten|default:"Chi tiết sản phẩm" }}{% endblock %}

{% block extra_css %}
<style>
  .pd-wrap{padding-top:1rem;padding-bottom:1.25rem}
  /* Ảnh nhỏ–vừa, không bự quá */
  .prod-media{max-width:420px;width:100%}
  .main-img{width:100%;aspect-ratio:4/3;object-fit:cover;border:1px solid #eee;border-radius:.8rem;background:#fafafa}
  .thumbs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
  .thumbs img{width:72px;height:72px;object-fit:cover;border-radius:.5rem;border:1px solid #eee;cursor:pointer;background:#fff}
  .thumbs img.active{outline:2px solid #16a34a}
  /* Thông tin */
  .badge-cat{background:#e8f5e9;color:#2e7d32}
  .price{color:#f59e0b;font-weight:700;font-size:1.35rem}
  .btn-buy{background:#2e7d32;color:#fff;border:none}
  .btn-buy:hover{background:#1b5e20}
  .btn-add{border:1px dashed #2e7d32;color:#2e7d32}
  /* Liên quan */
  .card-prod{border:1px solid #eee;border-radius:1rem;overflow:hidden;transition:.15s}
  .card-prod:hover{transform:translateY(-3px);box-shadow:0 10px 24px rgba(0,0,0,.06)}
  .card-prod img{aspect-ratio:1/1;object-fit:cover;background:#fafafa}
</style>
{% endblock %}

{% block content %}
<main class="container pd-wrap">
  {% if error %}
    <div class="alert alert-warning">{{ error }}</div>
  {% else %}
    <nav class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'shop:home' %}">Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="{% url 'shop:sanpham_list' %}">Sản phẩm</a></li>
        {% if product.danh_muc_ten %}<li class="breadcrumb-item">{{ product.danh_muc_ten }}</li>{% endif %}
        <li class="breadcrumb-item active" aria-current="page">{{ product.ten }}</li>
      </ol>
    </nav>

    <div class="row g-4 align-items-start">
      <!-- Ảnh: nhỏ–vừa -->
      <div class="col-md-5 col-lg-4 d-flex justify-content-center justify-content-md-start">
        <div class="prod-media">
          <img id="mainImg" class="main-img"
               src="{% if product.hinh_anh and product.hinh_anh.0 %}{{ MEDIA_URL }}{{ product.hinh_anh.0 }}{% else %}{% static 'images/placeholder/produce.png' %}{% endif %}"
               alt="{{ product.ten }}">
          {% if product.hinh_anh %}
          <div class="thumbs">
            {% for im in product.hinh_anh %}
              <img class="{% if forloop.first %}active{% endif %}"
                   src="{{ MEDIA_URL }}{{ im }}" data-src="{{ MEDIA_URL }}{{ im }}"
                   alt="thumb {{ forloop.counter }}">
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Thông tin mô tả kế bên -->
      <div class="col-md-7 col-lg-8">
        <span class="badge badge-cat mb-2">{{ product.danh_muc_ten }}</span>
        <h2 class="mb-2">{{ product.ten }}</h2>
        <div class="price mb-3">{{ product.gia|intcomma }} VNĐ</div>
        <div class="text-muted mb-3">{{ product.mo_ta|default:"" }}</div>

        <div class="d-flex flex-wrap gap-2 mt-2">
          <a href="#" class="btn btn-buy px-4" id="btnBuyNow">Mua ngay</a>
          <button class="btn btn-add px-4" id="btnAddCart" data-id="{{ product.id }}">
            <i class="bi bi-bag-plus"></i> Thêm vào giỏ
          </button>
        </div>
      </div>
    </div>

    {% if related %}
    <hr class="my-4">
    <h5 class="mb-3">Sản phẩm cùng danh mục</h5>
    <div class="row g-3">
      {% for r in related %}
      <div class="col-6 col-md-3 col-lg-3">
        <a class="card card-prod text-decoration-none text-dark h-100" href="{% url 'shop:product_detail' r.id %}">
          {% if r.img %}
            <img src="{{ MEDIA_URL }}{{ r.img }}" class="card-img-top" alt="{{ r.ten }}">
          {% else %}
            <img src="{% static 'images/placeholder/produce.png' %}" class="card-img-top" alt="{{ r.ten }}">
          {% endif %}
          <div class="card-body">
            <div class="fw-semibold text-truncate" title="{{ r.ten }}">{{ r.ten }}</div>
            <div class="text-warning fw-bold">{{ r.gia|intcomma }} VNĐ</div>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  {% endif %}
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Đổi ảnh chính
  document.querySelectorAll('.thumbs img').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.thumbs img').forEach(i => i.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('mainImg').src = el.dataset.src;
    });
  });

  // Thêm vào giỏ
  const addBtn = document.getElementById('btnAddCart');
  if (addBtn) {
    addBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const res = await fetch('/api/cart/items/', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ san_pham_id: addBtn.dataset.id, so_luong: 1 })
        });
        if (res.status === 201) {
          if (window.updateCartBadge) window.updateCartBadge();
          addBtn.classList.add('btn-success');
          setTimeout(()=>addBtn.classList.remove('btn-success'), 250);
        } else if (res.status === 400 || res.status === 401) {
          window.location.href = '{% url "shop:shop_login" %}';
        }
      } catch (e) { console.error(e); }
    });
  }

  // Mua ngay → thêm giỏ rồi sang trang giỏ
  const buyNow = document.getElementById('btnBuyNow');
  if (buyNow && addBtn) {
    buyNow.addEventListener('click', (e) => {
      e.preventDefault();
      addBtn.click();
      setTimeout(()=> window.location.href = '{% url 'shop:cart_page' %}', 120);
    });
  }
});
</script>
{% endblock %}
