{% extends "shop/base.html" %}
{% load static %}
{% block title %}Chi tiáº¿t Ä‘Æ¡n hÃ ng{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{% url 'shop:my_orders_page' %}" class="btn btn-sm btn-outline-secondary">â† Quay láº¡i danh sÃ¡ch</a>

    <div class="d-flex gap-2">
      <button id="btn-print" class="btn btn-sm btn-outline-primary">In</button>
      {% if order.trang_thai == 'cho_xu_ly' %}
      <button id="btn-cancel" class="btn btn-sm btn-danger">Há»§y Ä‘Æ¡n</button>
      {% endif %}
    </div>
  </div>

  <div class="card shadow-sm border-0 rounded-4 p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
      <div>
        <h4 class="text-success mb-2">Chi tiáº¿t Ä‘Æ¡n hÃ ng</h4>
        <div class="text-muted">MÃ£ Ä‘Æ¡n: <code>{{ order.id|slice:":8" }}</code></div>
      </div>
      <div class="text-end">
        <div class="mb-1">
          <span class="badge rounded-pill status-badge" data-status="{{ order.trang_thai }}">{{ order.trang_thai }}</span>
        </div>
        <div class="small text-muted">
          NgÃ y táº¡o: <span class="time" data-iso="{{ order.ngay_tao }}">{{ order.ngay_tao }}</span>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <div class="p-3 rounded-3 border bg-light">
          <div class="small text-muted">PhÆ°Æ¡ng thá»©c thanh toÃ¡n</div>
          <div class="fw-semibold mt-1">{{ order.phuong_thuc_thanh_toan|upper }}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="p-3 rounded-3 border bg-light">
          <div class="small text-muted">Tá»•ng tiá»n</div>
          <div class="fw-bold mt-1 h5 mb-0">
            <span class="money" data-v="{{ order.tong_tien }}">{{ order.tong_tien }}</span> Ä‘
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸ‘‡ ThÃ´ng tin Ä‘áº·t hÃ ng -->
    {% if order.nguoi_dat %}
    <div class="p-3 rounded-3 border mb-3">
      <div class="small text-muted">ThÃ´ng tin Ä‘áº·t hÃ ng</div>
      <div class="row mt-1">
        <div class="col-md-6">
          <div><strong>Há» tÃªn:</strong> {{ order.nguoi_dat.ten|default:"â€”" }}</div>
          <div><strong>Email:</strong> {{ order.nguoi_dat.email|default:"â€”" }}</div>
        </div>
        <div class="col-md-6">
          <div><strong>SÄT:</strong> {{ order.nguoi_dat.sdt|default:"â€”" }}</div>
          <div><strong>Äá»‹a chá»‰:</strong> {{ order.nguoi_dat.dia_chi|default:"â€”" }}</div>
        </div>
      </div>
    </div>
    {% endif %}

    <h6 class="text-secondary mb-2">Danh sÃ¡ch sáº£n pháº©m</h6>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>TÃªn sáº£n pháº©m</th>
            <th class="text-center" style="width:110px">Sá»‘ lÆ°á»£ng</th>
            <th class="text-end" style="width:160px">ÄÆ¡n giÃ¡</th>
            <th class="text-end" style="width:180px">ThÃ nh tiá»n</th>
          </tr>
        </thead>
        <tbody>
          {% if order.items %}
            {% for it in order.items %}
            <tr>
              <td>{{ it.san_pham_ten|default:"(KhÃ´ng rÃµ)" }}</td>
              <td class="text-center">{{ it.so_luong }}</td>
              <td class="text-end"><span class="money" data-v="{{ it.don_gia }}">{{ it.don_gia }}</span> Ä‘</td>
              <td class="text-end"><span class="money" data-v="{{ it.tong_tien }}">{{ it.tong_tien }}</span> Ä‘</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td>{{ order.san_pham_ten|default:"(KhÃ´ng rÃµ)" }}</td>
              <td class="text-center">{{ order.so_luong|default:1 }}</td>
              <td class="text-end"><span class="money" data-v="{{ order.don_gia|default:0 }}">{{ order.don_gia|default:0 }}</span> Ä‘</td>
              <td class="text-end"><span class="money" data-v="{{ order.tong_tien|default:0 }}">{{ order.tong_tien|default:0 }}</span> Ä‘</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .status-badge { text-transform: none; }
  .st-cho_xu_ly   { background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }
  .st-da_xac_nhan { background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; }
  .st-dang_giao   { background:#f0f9ff; color:#0369a1; border:1px solid #bae6fd; }
  .st-hoan_thanh  { background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; }
  .st-da_huy      { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
  #btn-print, #btn-cancel { border-radius: 999px; }
</style>

<script>
  function vnd(n){ try { return Number(n).toLocaleString('vi-VN'); } catch { return n; } }
  function fmtTime(iso){
    if(!iso) return 'â€”';
    try { const d=new Date(iso);
      const dd=d.toLocaleDateString('vi-VN');
      const hh=d.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
      return `${dd} ${hh}`;
    } catch { return iso; }
  }
  function mapStatusText(st){
    const m={'cho_xu_ly':'Chá» xá»­ lÃ½','da_xac_nhan':'ÄÃ£ xÃ¡c nháº­n','dang_giao':'Äang giao','hoan_thanh':'HoÃ n thÃ nh','da_huy':'ÄÃ£ há»§y'};
    return m[st]||st;
  }

  // Format
  document.querySelectorAll('.money').forEach(el=>el.textContent=vnd(el.dataset.v||el.textContent));
  document.querySelectorAll('.time').forEach(el=>el.textContent=fmtTime(el.dataset.iso||el.textContent));
  document.querySelectorAll('.status-badge').forEach(el=>{
    const st=(el.dataset.status||'').trim();
    el.textContent = mapStatusText(st);
    el.classList.add('st-'+st);
  });

  // In
  document.getElementById('btn-print')?.addEventListener('click', ()=> window.print());

  // Há»§y Ä‘Æ¡n
  const cancelBtn = document.getElementById('btn-cancel');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', async () => {
      if (!confirm('Báº¡n cháº¯c muá»‘n há»§y Ä‘Æ¡n nÃ y?')) return;
      try {
        const url = `{% url 'shop:api_order_detail' order.id %}?_method=PUT`;
        const form = new FormData();
        form.set('trang_thai', 'da_huy');
        const r = await fetch(url, { method: 'POST', body: form, credentials: 'same-origin' });
        if (!r.ok) {
          const data = await r.json().catch(()=>({}));
          alert('Há»§y tháº¥t báº¡i' + (data?.error?`: ${data.error}`:''));
          return;
        }
        location.reload();
      } catch (e) {
        alert('CÃ³ lá»—i máº¡ng, vui lÃ²ng thá»­ láº¡i!');
      }
    });
  }
</script>
{% endblock %}
