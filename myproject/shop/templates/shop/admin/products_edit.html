{% extends 'shop/admin/base_admin.html' %}
{% block title %}
  S·ª≠a s·∫£n ph·∫©m
{% endblock %}
{% block page_title %}
  S·ª≠a s·∫£n ph·∫©m
{% endblock %}

{% block content %}
  <div class="card shadow-sm">
    <div class="card-body">
      <form id="editForm" autocomplete="off">
        <div class="mb-3">
          <label class="form-label fw-semibold" for="ten">T√™n s·∫£n ph·∫©m</label>
          <input type="text" id="ten" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold" for="mo_ta">M√¥ t·∫£</label>
          <textarea id="mo_ta" class="form-control" rows="3"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold" for="gia">Gi√° (VNƒê)</label>
          <input type="number" id="gia" class="form-control" required min="0" step="1000" />
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold" for="hinh_anh">H√¨nh ·∫£nh (URL ho·∫∑c ƒë∆∞·ªùng d·∫´n)</label>
          <input type="text" id="hinh_anh" class="form-control" />
          <div class="mt-2">
            <img id="preview_img" src="" alt="Xem tr∆∞·ªõc h√¨nh ·∫£nh" style="max-height:150px; display:none; border:1px solid #ccc; padding:3px;" />
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold" for="danh_muc">Danh m·ª•c</label>
          <select id="danh_muc" class="form-select" required>
            <option value="">-- Ch·ªçn danh m·ª•c --</option>
            {% for dm in categories %}
              <option value="{{ dm.id }}">{{ dm.ten }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-primary" type="submit">L∆∞u thay ƒë·ªïi</button>
          <a class="btn btn-secondary" href="{% url 'shop:admin_products' %}">H·ªßy</a>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
;(async function () {
  const id = '{{ product_id }}'

  function getCookie(name) {
    let v = null
    if (document.cookie)
      for (let c of document.cookie.split(';')) {
        c = c.trim()
        if (c.startsWith(name + '=')) {
          v = decodeURIComponent(c.split('=')[1])
          break
        }
      }
    return v
  }
  const CSRF = getCookie('csrftoken')

  // n·∫°p d·ªØ li·ªáu hi·ªán t·∫°i
  const res = await fetch(`/api/products/${id}/`)
  if (!res.ok) {
    alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m')
    window.location = "{% url 'shop:admin_products' %}"
    return
  }
  const cur = await res.json()

  document.getElementById('ten').value = cur.ten_san_pham || ''
  document.getElementById('mo_ta').value = cur.mo_ta || ''
  document.getElementById('gia').value = cur.gia || 0
  document.getElementById('hinh_anh').value =
    cur.hinh_anh && cur.hinh_anh.length > 0 ? cur.hinh_anh[0] : ''

  // üü¢ th√™m d√≤ng n√†y ƒë·ªÉ gi·ªØ danh m·ª•c ƒë√£ ch·ªçn
  document.getElementById('danh_muc').value = cur.danh_muc_id || ''

  if (cur.hinh_anh && cur.hinh_anh.length > 0) {
    const preview = document.getElementById('preview_img')
    preview.src = '/media/' + cur.hinh_anh[0] // lu√¥n th√™m /media/
    preview.style.display = 'block'
  } else {
    document.getElementById('preview_img').style.display = 'none'
  }

  // submit PUT
  document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault()
    const payload = {
      ten_san_pham: document.getElementById('ten').value.trim(),
      mo_ta: document.getElementById('mo_ta').value.trim(),
      gia: parseInt(document.getElementById('gia').value, 10) || 0,
      hinh_anh: document.getElementById('hinh_anh').value.trim()
        ? [document.getElementById('hinh_anh').value.trim()]
        : [],
      danh_muc_id: document.getElementById('danh_muc').value
    }
    if (!payload.ten_san_pham || !payload.danh_muc_id) {
      alert('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin')
      return
    }

    const r = await fetch(`/api/products/${id}/`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
      body: JSON.stringify(payload)
    })
    if (r.ok) {
      window.location = "{% url 'shop:admin_products' %}"
    } else {
      const err = await r.json().catch(() => ({}))
      alert(err.error || 'L∆∞u th·∫•t b·∫°i')
    }
  })

  // preview khi ng∆∞·ªùi d√πng g√µ v√†o √¥ input
  document.getElementById('hinh_anh').addEventListener('input', function () {
    const val = this.value.trim()
    const preview = document.getElementById('preview_img')
    if (val) {
      preview.src = '/media/' + val
      preview.style.display = 'block'
    } else {
      preview.style.display = 'none'
    }
  })
})()
</script>
{% endblock %}
