{% extends "shop/base.html" %}
{% load static %}
{% block title %}Đặt hàng{% endblock %}

{% block content %}
<style>
  .checkout-cart-item{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.35rem 0}
  .checkout-cart-item .left{display:flex;align-items:center;gap:.6rem;min-width:0}
  .checkout-cart-item .thumb{width:44px;height:44px;flex:0 0 44px;border-radius:.5rem;object-fit:cover;border:1px solid #e9ecef;background:#fff}
  .checkout-cart-item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
  .bank-hint code{background:#f8f9fa;border:1px dashed #e1e1e1;border-radius:.35rem;padding:.15rem .35rem}
</style>

<section class="py-4">
  <div class="container">
    <h2 class="h4 mb-4"><i class="bi bi-bag-check me-2"></i>Đặt hàng</h2>

    <div class="row g-4">
      <div class="col-lg-7">
        <div class="card border-success-subtle">
          <div class="card-body">
            <h5 class="card-title mb-3">Thông tin nhận hàng</h5>

            <form id="checkoutForm" class="row g-3" autocomplete="off" novalidate>
              <div class="col-md-6">
                <label class="form-label" for="inputName">Họ và tên</label>
                <input name="ho_ten" id="inputName" type="text" class="form-control" placeholder="Nhập họ và tên" autocomplete="name" required>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="inputPhone">Số điện thoại</label>
                <input name="sdt" id="inputPhone" type="tel" class="form-control" required inputmode="numeric" pattern="^[0-9]{8,15}$" maxlength="15" placeholder="Nhập số điện thoại" title="Chỉ nhập số, từ 8 đến 15 ký tự" autocomplete="tel">
              </div>
              <div class="col-12">
                <label class="form-label" for="inputAddress">Địa chỉ</label>
                <input name="dia_chi" id="inputAddress" type="text" class="form-control" placeholder="Nhập địa chỉ" autocomplete="street-address" required>
              </div>
              <div class="col-12">
                <label class="form-label" for="inputNote">Ghi chú</label>
                <textarea name="ghi_chu" id="inputNote" class="form-control" rows="2" placeholder="Nhập ghi chú (nếu có)"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="paymentSelect">Phương thức thanh toán</label>
                <select name="phuong_thuc_thanh_toan" id="paymentSelect" class="form-select">
                  <option value="cod" selected>COD (Thanh toán khi nhận hàng)</option>
                  <option value="chuyen_khoan">Chuyển khoản</option>
                </select>
              </div>

              <!-- Hướng dẫn chuyển khoản -->
              <div class="col-12" id="bankTransferWrap" style="display:none;">
                <div class="alert alert-success-subtle border border-success-subtle bank-hint">
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-bank me-2"></i><strong>Hướng dẫn chuyển khoản</strong>
                  </div>

                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label mb-1" for="bankName">Ngân hàng</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="bankName" value="Tiên Phong Bank" readonly>
                        <button class="btn btn-outline-success" type="button" data-copy="#bankName"><i class="bi bi-clipboard"></i></button>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label mb-1" for="bankNo">Số tài khoản</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="bankNo" value="89756888888" readonly>
                        <button class="btn btn-outline-success" type="button" data-copy="#bankNo"><i class="bi bi-clipboard"></i></button>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label mb-1" for="bankOwner">Chủ tài khoản</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="bankOwner" value="Lâm Diệu Kiệt" readonly>
                        <button class="btn btn-outline-success" type="button" data-copy="#bankOwner"><i class="bi bi-clipboard"></i></button>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label mb-1" for="bankMemo">Nội dung chuyển khoản</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="bankMemo" value="Thanh toan don hang - SDT: 0xxx " readonly>
                        <button class="btn btn-outline-success" type="button" data-copy="#bankMemo"><i class="bi bi-clipboard"></i></button>
                      </div>
                    </div>
                  </div>

                  <hr class="my-3">
                  <ul class="small mb-0">
                    <li>Chuyển đúng số tiền <strong>Tổng cộng</strong> hiển thị.</li>
                    <li>Hệ thống sẽ xác nhận khi nhận được giao dịch và cập nhật trạng thái đơn.</li>
                  </ul>
                </div>
              </div>
              <!-- /Hướng dẫn chuyển khoản -->
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card border-success-subtle">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Tóm tắt</h5>
              
            </div>

            <div id="cartList" class="small mb-2 text-muted"></div>

            <div class="d-flex justify-content-between">
              <span class="text-muted">Tạm tính</span>
              <span id="sumSubtotal">0</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-semibold fs-5">
              <span>Tổng cộng</span>
              <span id="sumTotal">0</span>
            </div>
            <button id="btnPlaceOrder" class="btn btn-success w-100 mt-3" disabled>
              <i class="bi bi-check2-circle me-1"></i> Xác nhận đặt hàng
            </button>
            <a href="{% url 'shop:cart_page' %}" class="btn btn-outline-success w-100 mt-2">← Quay lại giỏ hàng</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div id="toast" class="toast align-items-center text-white position-fixed top-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true" style="z-index:1100;">
  <div class="d-flex">
    <div class="toast-body"></div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(() => {
  const MEDIA_URL = "{{ MEDIA_URL|default:'' }}";
  const PLACEHOLDER_URL = "{% static 'images/placeholder/produce.png' %}";
  const money = v => (Number(v||0)).toLocaleString('vi-VN') + ' VNĐ';

  // Toast
  const toastEl = document.getElementById('toast');
  function toast(msg, error=false){
    toastEl.classList.remove('bg-success','bg-danger');
    toastEl.classList.add(error?'bg-danger':'bg-success');
    toastEl.querySelector('.toast-body').textContent = msg;
    new bootstrap.Toast(toastEl, {delay:2000}).show();
  }

  // DOM
  const cartList    = document.getElementById('cartList');
  const sumSubtotal = document.getElementById('sumSubtotal');
  const sumTotal    = document.getElementById('sumTotal');
  const btnPlace    = document.getElementById('btnPlaceOrder');
  const form        = document.getElementById('checkoutForm');
  const paySelect   = document.getElementById('paymentSelect');
  const bankWrap    = document.getElementById('bankTransferWrap');
  const memoInput   = document.getElementById('bankMemo');
  const inputPhone  = document.getElementById('inputPhone');

  // Phone only digits
  const digitsOnly = (s) => (s || '').replace(/\D+/g, '').slice(0, 15);
  function sanitizePhone(){ const cur=inputPhone.value, clean=digitsOnly(cur); if(cur!==clean) inputPhone.value=clean; }
  inputPhone.addEventListener('input', sanitizePhone);
  inputPhone.addEventListener('paste', (e)=>{ e.preventDefault(); const t=(e.clipboardData||window.clipboardData).getData('text'); document.execCommand('insertText', false, digitsOnly(t)); });
  inputPhone.addEventListener('drop',  (e)=>{ e.preventDefault(); const t=e.dataTransfer.getData('text'); inputPhone.value = digitsOnly(t); });
  inputPhone.addEventListener('keypress', (e)=>{ const d=/[0-9]/.test(e.key); const ctl=["Backspace","Delete","ArrowLeft","ArrowRight","Tab","Home","End","Enter"].includes(e.key); if(!d&&!ctl)e.preventDefault(); });

  // Bank guide
  function toggleBankGuide(){ bankWrap.style.display = (paySelect.value === 'chuyen_khoan') ? '' : 'none'; }
  paySelect.addEventListener('change', toggleBankGuide); toggleBankGuide();

  // Auto memo = phone
  form.querySelector('[name="sdt"]').addEventListener('input', (e)=>{ const phone=(e.target.value||'').replace(/\s+/g,''); memoInput && (memoInput.value = 'Thanh toan don hang - SDT: ' + phone); });

  // Copy helper
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-copy]'); if(!btn) return;
    const sel = btn.getAttribute('data-copy'); const input = document.querySelector(sel); if(!input) return;
    try{ await navigator.clipboard.writeText(input.value||''); toast('Đã sao chép!'); }catch{ toast('Không sao chép được, vui lòng copy thủ công.', true); }
  });

  // ===== BUY NOW utils (ưu tiên sessionStorage, fallback localStorage)
  function getBuyNowItem(){
    const parse = (s)=>{ try{ return JSON.parse(s||'null'); }catch{return null;} };
    const s1 = parse(sessionStorage.getItem('buy_now_item'));
    if (s1 && s1.san_pham_id) return s1;
    const s2 = parse(localStorage.getItem('buy_now_item'));
    return (s2 && s2.san_pham_id) ? s2 : null;
  }
  function clearBuyNow(){
    try{ sessionStorage.removeItem('buy_now_item'); }catch{}
    try{ localStorage.removeItem('buy_now_item'); }catch{}
  }
  document.getElementById('cancelBuyNow')?.addEventListener('click', ()=>{ clearBuyNow(); location.reload(); });

  // Load tóm tắt
  async function loadCart(){
    const buyNow = getBuyNowItem();
    if (buyNow && buyNow.san_pham_id){
      const img  = buyNow.img || PLACEHOLDER_URL;
      const name = buyNow.ten || 'Sản phẩm';
      const qty  = Number(buyNow.so_luong || 1);
      const line = Number(buyNow.gia || 0) * qty;

      cartList.innerHTML = `
        <div class="checkout-cart-item">
          <div class="left">
            <img class="thumb" src="${img}" alt="${name}">
            <div class="name" title="${name}">${name} × ${qty}</div>
          </div>
          <div class="right fw-semibold">${money(line)}</div>
        </div>`;
      sumSubtotal.textContent = money(line);
      sumTotal.textContent    = money(line);
      btnPlace.disabled = false;
      return;
    }

    // Fallback: lấy từ giỏ
    const res = await fetch('/api/cart/?include_product=1');
    if(!res.ok){ cartList.innerHTML='Giỏ hàng trống.'; btnPlace.disabled=true; return; }
    const data = await res.json();
    const items = data.items||[];
    if(!items.length){ cartList.innerHTML='Giỏ hàng trống.'; btnPlace.disabled=true; return; }
    btnPlace.disabled=false;

    let html='', subtotal=0;
    items.forEach(it=>{
      const sp = it.san_pham||{};
      const imgs = sp.hinh_anh || sp.hinh_anh_urls || [];
      let img = (Array.isArray(imgs) && imgs.length && imgs[0]) ? (String(imgs[0]).startsWith('http') ? String(imgs[0]) : (MEDIA_URL + String(imgs[0]))) : PLACEHOLDER_URL;
      const name = sp.ten_san_pham || sp.ten || 'Sản phẩm';
      subtotal += Number(it.tong_tien||0);
      html += `
        <div class="checkout-cart-item">
          <div class="left">
            <img class="thumb" src="${img}" alt="${name}">
            <div class="name" title="${name}">${name} × ${it.so_luong}</div>
          </div>
          <div class="right fw-semibold">${money(it.tong_tien)}</div>
        </div>`;
    });
    cartList.innerHTML = html;
    sumSubtotal.textContent = money(subtotal);
    sumTotal.textContent    = money(subtotal);
  }

  // Đặt hàng
  document.getElementById('btnPlaceOrder').addEventListener('click', async ()=>{
    sanitizePhone();
    const phone = inputPhone.value;
    if (!phone || !/^[0-9]{8,15}$/.test(phone)){ toast('SĐT không hợp lệ (chỉ số 0–9, 8–15 ký tự).', true); inputPhone.focus(); return; }

    const fd = new FormData(form);
    const baseInfo = {
      phuong_thuc_thanh_toan: fd.get('phuong_thuc_thanh_toan') || 'cod',
      ho_ten: (fd.get('ho_ten')||'').trim(),
      sdt: phone,
      dia_chi: (fd.get('dia_chi')||'').trim(),
      ghi_chu: (fd.get('ghi_chu')||'').trim(),
    };
    if(!baseInfo.ho_ten || !baseInfo.dia_chi){ toast('Vui lòng điền đủ họ tên và địa chỉ', true); return; }

    const buyNow = getBuyNowItem();
    const payload = (buyNow && buyNow.san_pham_id)
      ? { use_cart:false, ...baseInfo, items:[{ san_pham_id: buyNow.san_pham_id, so_luong: buyNow.so_luong || 1 }] }
      : { use_cart:true,  ...baseInfo };

    const res = await fetch('/api/orders/checkout/', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    if(res.ok){
      toast('Đặt hàng thành công!');
      clearBuyNow();
      setTimeout(()=>{ window.location.href = "{% url 'shop:my_orders_page' %}"; }, 800);
    }else{
      let err={}; try{ err=await res.json(); }catch{}
      toast('Lỗi đặt hàng: ' + (err.message || err.error || res.status), true);
    }
  });

  loadCart();
})();
</script>
{% endblock %}
