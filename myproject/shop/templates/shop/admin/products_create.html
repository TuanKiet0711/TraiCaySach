{% extends 'shop/admin/base_admin.html' %}
{% block title %}Thêm sản phẩm{% endblock %}
{% block page_title %}Thêm sản phẩm{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <form id="createForm" autocomplete="off" enctype="multipart/form-data">
      <div class="mb-3">
        <label class="form-label fw-semibold" for="ten">Tên sản phẩm</label>
        <input type="text" id="ten" class="form-control" required placeholder="Nhập tên sản phẩm" />
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold" for="mo_ta">Mô tả</label>
        <textarea id="mo_ta" class="form-control" rows="3" placeholder="Mô tả sản phẩm…"></textarea>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-semibold" for="gia">Giá (VNĐ)</label>
          <!-- type=text để format dấu phẩy khi gõ -->
          <input
            type="text"
            id="gia"
            class="form-control"
            required
            inputmode="numeric"
            pattern="[0-9,]*"
            placeholder="Nhập giá"
            autocomplete="off"
          />
        </div>

        <!-- SỐ LƯỢNG TỒN -->
        <div class="col-md-6">
          <label class="form-label fw-semibold" for="so_luong_ton">Số lượng tồn</label>
          <input
            type="number"
            id="so_luong_ton"
            class="form-control"
            inputmode="numeric"
            min="0"
            step="1"
            value="0"
            placeholder="Nhập tồn kho (>= 0)"
            required
          />
        </div>
      </div>

      <div class="mb-3 mt-3">
        <label class="form-label fw-semibold" for="hinh_anh">Hình ảnh</label>
        <input type="file" id="hinh_anh" class="form-control" accept="image/*" />
        <div class="mt-2">
          <img id="preview_img" src="" alt="Xem trước ảnh" style="max-height:120px; display:none; border:1px solid #ccc; padding:3px;">
        </div>
      </div>

      <!-- Danh mục: Dropdown có scroll -->
      <div class="mb-3">
        <label class="form-label">Danh mục</label>

        <!-- Trường ẩn giữ giá trị để submit -->
        <input type="hidden" id="danh_muc_id" required>

        <!-- Nút mở dropdown -->
        <div class="dropdown w-100">
          <button
            class="btn btn-outline-secondary w-100 d-flex justify-content-between align-items-center"
            type="button"
            id="btnDanhMuc"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <span id="labelDanhMuc">-- Chọn danh mục --</span>
            <span class="ms-2">▾</span>
          </button>

          <!-- Menu có giới hạn chiều cao + scroll -->
          <ul class="dropdown-menu w-100 p-1" style="max-height: 260px; overflow: auto;">
            {% for cat in categories %}
              <li>
                <a class="dropdown-item" href="#" data-id="{{ cat.id }}">{{ cat.ten }}</a>
              </li>
            {% endfor %}
          </ul>
        </div>

        <div class="form-text text-danger d-none" id="dmError">Vui lòng chọn danh mục</div>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-success" type="submit">Lưu</button>
        <a class="btn btn-secondary" href="{% url 'shop:admin_products' %}">Hủy</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
;(function () {
  // ---- CSRF helper ----
  function getCookie(name) {
    let v = null
    if (document.cookie)
      for (let c of document.cookie.split(';')) {
        c = c.trim()
        if (c.startsWith(name + '=')) { v = decodeURIComponent(c.split('=')[1]); break }
      }
    return v
  }
  const CSRF = getCookie('csrftoken')

  // ---- DOM refs ----
  const form      = document.getElementById('createForm')
  const fileInput = document.getElementById('hinh_anh')
  const preview   = document.getElementById('preview_img')

  // Dropdown Danh mục
  const dmHidden = document.getElementById('danh_muc_id')
  const dmLabel  = document.getElementById('labelDanhMuc')
  const dmError  = document.getElementById('dmError')
  const dmMenu   = document.querySelector('.dropdown .dropdown-menu')

  // ---- Preview ảnh ----
  fileInput.addEventListener('change', () => {
    if (fileInput.files && fileInput.files[0]) {
      const reader = new FileReader()
      reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block' }
      reader.readAsDataURL(fileInput.files[0])
    } else {
      preview.style.display = 'none'
    }
  })

  // ---- Chọn danh mục ----
  dmMenu.addEventListener('click', (e) => {
    const item = e.target.closest('.dropdown-item'); if (!item) return
    e.preventDefault()
    dmHidden.value = item.dataset.id || ''
    dmLabel.textContent = item.textContent.trim() || '-- Chọn danh mục --'
    dmError.classList.add('d-none')
  })

  // ---- Format giá có dấu phẩy khi gõ ----
  const giaInput = document.getElementById('gia')
  const formatComma = (digitsStr) => {
    const clean = (digitsStr || '').replace(/[^\d]/g, '')
    if (!clean) return ''
    return clean.replace(/\B(?=(\d{3})+(?!\d))/g, ',')
  }
  giaInput.addEventListener('input', (e) => {
    const val = e.target.value
    const formatted = formatComma(val)
    if (formatted !== val) {
      const end = formatted.length
      e.target.value = formatted
      e.target.setSelectionRange(end, end)
    }
  })
  giaInput.addEventListener('keypress', (e) => {
    const isDigit = /\d/.test(e.key)
    const isCtrl = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End','Enter'].includes(e.key)
    if (!isDigit && !isCtrl) e.preventDefault()
  })
  giaInput.addEventListener('blur', (e) => { e.target.value = formatComma(e.target.value) })

  // ---- Submit ----
  form.addEventListener('submit', async (e) => {
    e.preventDefault()
    const ten    = document.getElementById('ten').value.trim()
    const mo_ta  = document.getElementById('mo_ta').value.trim()
    const giaRaw = giaInput.value.trim()
    const gia    = parseInt(giaRaw.replace(/[^\d]/g, ''), 10) || 0
    const danh_muc_id  = dmHidden.value
    const so_luong_ton = Math.max(0, parseInt(document.getElementById('so_luong_ton').value, 10) || 0)

    if (!ten || !danh_muc_id) {
      if (!danh_muc_id) dmError.classList.remove('d-none')
      alert('Vui lòng nhập đủ thông tin')
      return
    }

    const formData = new FormData()
    formData.append('ten_san_pham', ten)
    formData.append('mo_ta', mo_ta)
    formData.append('gia', gia)                 // số nguyên
    formData.append('danh_muc_id', danh_muc_id)
    formData.append('so_luong_ton', so_luong_ton) // <<< THÊM TỒN
    if (fileInput.files.length > 0) formData.append('hinh_anh', fileInput.files[0])

    const res = await fetch("{% url 'shop:api_products_create' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF },
      body: formData
    })

   // CREATE page JS (products_create.html)
if (res.ok) {
  window.location = "{% url 'shop:admin_products' %}?ok=created";
} else {
  const err = await res.json().catch(() => ({}));
  alert(err.error || 'Tạo sản phẩm thất bại');
}

  })
})()
</script>
{% endblock %}
