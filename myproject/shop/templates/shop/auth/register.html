{% extends "shop/base.html" %}
{% block title %}ÄÄƒng kÃ½ - TrÃ¡i CÃ¢y Sáº¡ch{% endblock %}
{% block content %}
<style>
.card {
  border-radius: 1rem;
  border: 1px solid #dee2e6;
  box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
}
.btn-success {
  background-color: #198754;
  border-color: #198754;
}
.btn-success:hover {
  background-color: #157347;
  border-color: #146c43;
}
.form-control:focus {
  border-color: #198754;
  box-shadow: 0 0 0 0.25rem rgba(25,135,84,.25);
}
</style>

<div class="row justify-content-center">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-sm border-0 mt-4">
      <div class="card-body p-4">
        <h3 class="text-center mb-4 text-success fw-bold">ÄÄƒng kÃ½ tÃ i khoáº£n</h3>

        <form id="registerForm">
          <div class="mb-3">
            <label class="form-label fw-semibold">Há» tÃªn</label>
            <input type="text" name="ho_ten" class="form-control" placeholder="Nháº­p há» tÃªn" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Email</label>
            <input type="email" name="email" class="form-control" placeholder="Nháº­p email" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
            <input id="sdt" type="text" name="sdt" class="form-control"
                   placeholder="Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i" maxlength="10"
                   inputmode="numeric" pattern="[0-9]*">
          </div>

          <!-- âœ… Máº­t kháº©u vÃ  Nháº­p láº¡i máº­t kháº©u cÃ¹ng hÃ ng -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Máº­t kháº©u</label>
              <input type="password" name="mat_khau" class="form-control" placeholder="Nháº­p máº­t kháº©u" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Nháº­p láº¡i</label>
              <input type="password" name="mat_khau2" class="form-control" placeholder="Nháº­p láº¡i máº­t kháº©u" required>
            </div>
          </div>

          <button type="submit" class="btn btn-success w-100 py-2 fw-bold shadow-sm">
            ÄÄƒng kÃ½
          </button>
        </form>

        <div class="text-center mt-3">
          <small>ÄÃ£ cÃ³ tÃ i khoáº£n? <a href="{% url 'shop:shop_login' %}">ÄÄƒng nháº­p</a></small>
        </div>

        <div id="registerMsg" class="mt-3 text-center"></div>
      </div>
    </div>
  </div>
</div>

<script>
const sdt = document.getElementById('sdt');

// âœ… Cháº·n nháº­p chá»¯ & kÃ½ tá»± Ä‘áº·c biá»‡t
sdt.addEventListener('keydown', e => {
  const allowed = ['Backspace','Delete','Tab','Escape','Enter','ArrowLeft','ArrowRight','Home','End'];
  if (allowed.includes(e.key)) return;
  if (/^[0-9]$/.test(e.key)) {
    if (sdt.value.length >= 10) e.preventDefault();
    return;
  }
  e.preventDefault();
});

// âœ… Cháº·n dÃ¡n chá»¯, chá»‰ giá»¯ sá»‘
sdt.addEventListener('paste', e => {
  e.preventDefault();
  const clip = (e.clipboardData || window.clipboardData).getData('text') || '';
  const digits = clip.replace(/\D/g, '').slice(0, 10);
  document.execCommand('insertText', false, digits);
});

// âœ… Xá»­ lÃ½ submit
document.getElementById('registerForm').addEventListener('submit', async e => {
  e.preventDefault();
  const f = e.target;
  const ho_ten = f.ho_ten.value.trim();
  const email = f.email.value.trim();
  const sdtVal = f.sdt.value.trim();
  const mat_khau = f.mat_khau.value.trim();
  const mat_khau2 = f.mat_khau2.value.trim();
  const msg = document.getElementById('registerMsg');

  if (mat_khau !== mat_khau2) {
    msg.innerHTML = '<div class="alert alert-danger">Máº­t kháº©u nháº­p láº¡i khÃ´ng khá»›p</div>';
    return;
  }

  if (sdtVal && !/^\d{10}$/.test(sdtVal)) {
    msg.innerHTML = '<div class="alert alert-danger">Sá»‘ Ä‘iá»‡n thoáº¡i pháº£i gá»“m Ä‘Ãºng 10 chá»¯ sá»‘</div>';
    return;
  }

  const res = await fetch('/api/auth/register', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ ho_ten, email, sdt: sdtVal, mat_khau })
  });

  if (res.ok) {
    msg.innerHTML = '<div class="alert alert-success">ÄÄƒng kÃ½ thÃ nh cÃ´ng ğŸ‰</div>';
    setTimeout(() => location.href = '{% url "shop:home" %}', 1200);
  } else {
    const data = await res.json().catch(() => ({}));
    msg.innerHTML = '<div class="alert alert-danger">' + (data.error || 'ÄÄƒng kÃ½ tháº¥t báº¡i') + '</div>';
  }
});
</script>
{% endblock %}
