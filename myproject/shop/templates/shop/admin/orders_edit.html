{% extends "shop/admin/base_admin.html" %}
{% load humanize %}
{% load static %}
{% block title %}Sửa đơn hàng{% endblock %}
{% block page_title %}Sửa đơn hàng{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="text-success mb-0">Đơn hàng</h4>
    <a href="{% url 'shop:admin_orders' %}" class="btn btn-outline-secondary rounded-pill">← Quay lại</a>
  </div>

  <div class="card shadow-sm border-0 rounded-4 p-4">
    <form id="editForm">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label small text-muted">Mã đơn</label>
          <input type="text" id="order-id" class="form-control" readonly>
        </div>
        <div class="col-md-6">
          <label class="form-label small text-muted">Tài khoản</label>
          <input type="text" id="order-account" class="form-control" readonly>
        </div>

        <div class="col-md-6">
          <label class="form-label small text-muted">Phương thức thanh toán</label>
          <input type="text" id="order-pay" class="form-control" readonly>
        </div>

        <div class="col-md-6">
          <label class="form-label small text-muted">Trạng thái</label>
          <select id="order-status" class="form-select">
            <option value="cho_xu_ly">Chờ xử lý</option>
            <option value="da_xac_nhan">Đã xác nhận</option>
            <option value="dang_giao">Đang giao</option>
            <option value="hoan_thanh">Hoàn thành</option>
            <option value="da_huy">Đã hủy</option>
          </select>
        </div>
      </div>

      <hr class="my-4">

      <h6 class="text-secondary mb-2">Thông tin người đặt</h6>
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label small text-muted">Họ tên</label>
          <input id="nguoi-ten" class="form-control mb-2" readonly>
          <label class="form-label small text-muted">SĐT</label>
          <input id="nguoi-sdt" class="form-control" readonly>
        </div>
        <div class="col-md-8">
          <label class="form-label small text-muted">Địa chỉ</label>
          <input id="nguoi-diachi" class="form-control mb-2" readonly>
          <label class="form-label small text-muted">Ghi chú</label>
          <textarea id="nguoi-ghichu" class="form-control" rows="2" readonly></textarea>
        </div>
      </div>

      <h6 class="text-secondary mb-2">Danh sách sản phẩm</h6>
      <div class="table-responsive mb-3">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:70px"></th>
              <th>Tên sản phẩm</th>
              <th class="text-center" style="width:110px">Số lượng</th>
              <th class="text-end" style="width:160px">Đơn giá</th>
              <th class="text-end" style="width:180px">Thành tiền</th>
            </tr>
          </thead>
          <tbody id="items-body"></tbody>
        </table>
      </div>

      <div class="text-end fw-bold h5 mb-3">
        Tổng cộng: <span id="order-total">0</span> đ
      </div>

      <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-success rounded-pill px-4">Lưu thay đổi</button>
      </div>
    </form>
  </div>
</div>

<style>
  .table th, .table td { vertical-align: middle; }
  img.thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
</style>

<script>
  const ORDER_ID = "{{ order_id }}";
  const API_URL = `/api/orders/${ORDER_ID}/`;

  function vnd(n){ try{return Number(n).toLocaleString('vi-VN')}catch{return n;} }

  async function loadOrder(){
    try{
      const res = await fetch(API_URL, {credentials:"include"});
      if(!res.ok) throw new Error("Không tải được đơn hàng");
      const o = await res.json();

      document.getElementById("order-id").value = o.id.slice(0,8);
      document.getElementById("order-account").value = o.tai_khoan_ten || "—";
      document.getElementById("order-pay").value = (o.phuong_thuc_thanh_toan||"COD").toUpperCase();
      document.getElementById("order-status").value = o.trang_thai || "cho_xu_ly";
      document.getElementById("order-total").textContent = vnd(o.tong_tien||0);

      if(o.nguoi_dat){
        document.getElementById("nguoi-ten").value = o.nguoi_dat.ten || "";
        document.getElementById("nguoi-sdt").value = o.nguoi_dat.sdt || "";
        document.getElementById("nguoi-diachi").value = o.nguoi_dat.dia_chi || "";
        document.getElementById("nguoi-ghichu").value = o.nguoi_dat.ghi_chu || "";
      }

      const body = document.getElementById("items-body");
      body.innerHTML = "";
      (o.items||[]).forEach(it=>{
        const imgSrc = it.anh || it.image_url || "{% static 'img/no-image.png' %}";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><img src="${imgSrc}" class="thumb" onerror="this.src='https://via.placeholder.com/60?text=%20';"></td>
          <td>${it.san_pham_ten||"(Không rõ)"}</td>
          <td class="text-center">${it.so_luong}</td>
          <td class="text-end">${vnd(it.don_gia)} đ</td>
          <td class="text-end">${vnd(it.tong_tien)} đ</td>
        `;
        body.appendChild(tr);
      });
    }catch(err){
      alert(err.message);
    }
  }

  document.getElementById("editForm").addEventListener("submit", async e=>{
    e.preventDefault();
    const status = document.getElementById("order-status").value;
    try{
      const res = await fetch(API_URL,{
        method:"PUT",
        credentials:"include",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({trang_thai: status})
      });
      if(!res.ok) throw new Error("Cập nhật thất bại");
      alert("✅ Cập nhật trạng thái thành công!");
      window.location.href = "{% url 'shop:admin_orders' %}";
    }catch(err){
      alert(err.message);
    }
  });

  loadOrder();
</script>
{% endblock %}
