{% extends "shop/base.html" %}
{% block title %}Đăng ký - Trái Cây Sạch{% endblock %}
{% block content %}
<style>
.card {
  border-radius: 1rem;
  border: 1px solid #dee2e6;
  box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
}
.btn-success {
  background-color: #198754;
  border-color: #198754;
}
.btn-success:hover {
  background-color: #157347;
  border-color: #146c43;
}
.form-control:focus {
  border-color: #198754;
  box-shadow: 0 0 0 0.25rem rgba(25,135,84,.25);
}
</style>

<div class="row justify-content-center">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-sm border-0 mt-4">
      <div class="card-body p-4">
        <h3 class="text-center mb-4 text-success fw-bold">Đăng ký tài khoản</h3>

        <form id="registerForm">
          <div class="mb-3">
            <label class="form-label fw-semibold">Họ tên</label>
            <input type="text" name="ho_ten" class="form-control" placeholder="Nhập họ tên" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Email</label>
            <input type="email" name="email" class="form-control" placeholder="Nhập email" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Số điện thoại</label>
            <input id="sdt" type="text" name="sdt" class="form-control"
                   placeholder="Nhập số điện thoại" maxlength="10"
                   inputmode="numeric" pattern="[0-9]*">
          </div>

          <!-- ✅ Mật khẩu và Nhập lại mật khẩu cùng hàng -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Mật khẩu</label>
              <input type="password" name="mat_khau" class="form-control" placeholder="Nhập mật khẩu" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Nhập lại</label>
              <input type="password" name="mat_khau2" class="form-control" placeholder="Nhập lại mật khẩu" required>
            </div>
          </div>

          <button type="submit" class="btn btn-success w-100 py-2 fw-bold shadow-sm">
            Đăng ký
          </button>
        </form>

        <div class="text-center mt-3">
          <small>Đã có tài khoản? <a href="{% url 'shop:shop_login' %}">Đăng nhập</a></small>
        </div>

        <div id="registerMsg" class="mt-3 text-center"></div>
      </div>
    </div>
  </div>
</div>

<script>
const sdt = document.getElementById('sdt');

// ✅ Chặn nhập chữ & ký tự đặc biệt
sdt.addEventListener('keydown', e => {
  const allowed = ['Backspace','Delete','Tab','Escape','Enter','ArrowLeft','ArrowRight','Home','End'];
  if (allowed.includes(e.key)) return;
  if (/^[0-9]$/.test(e.key)) {
    if (sdt.value.length >= 10) e.preventDefault();
    return;
  }
  e.preventDefault();
});

// ✅ Chặn dán chữ, chỉ giữ số
sdt.addEventListener('paste', e => {
  e.preventDefault();
  const clip = (e.clipboardData || window.clipboardData).getData('text') || '';
  const digits = clip.replace(/\D/g, '').slice(0, 10);
  document.execCommand('insertText', false, digits);
});

// ✅ Xử lý submit
document.getElementById('registerForm').addEventListener('submit', async e => {
  e.preventDefault();
  const f = e.target;
  const ho_ten = f.ho_ten.value.trim();
  const email = f.email.value.trim();
  const sdtVal = f.sdt.value.trim();
  const mat_khau = f.mat_khau.value.trim();
  const mat_khau2 = f.mat_khau2.value.trim();
  const msg = document.getElementById('registerMsg');

  if (mat_khau !== mat_khau2) {
    msg.innerHTML = '<div class="alert alert-danger">Mật khẩu nhập lại không khớp</div>';
    return;
  }

  if (sdtVal && !/^\d{10}$/.test(sdtVal)) {
    msg.innerHTML = '<div class="alert alert-danger">Số điện thoại phải gồm đúng 10 chữ số</div>';
    return;
  }

  const res = await fetch('/api/auth/register', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ ho_ten, email, sdt: sdtVal, mat_khau })
  });

  if (res.ok) {
    msg.innerHTML = '<div class="alert alert-success">Đăng ký thành công 🎉</div>';
    setTimeout(() => location.href = '{% url "shop:home" %}', 1200);
  } else {
    const data = await res.json().catch(() => ({}));
    msg.innerHTML = '<div class="alert alert-danger">' + (data.error || 'Đăng ký thất bại') + '</div>';
  }
});
</script>
{% endblock %}
