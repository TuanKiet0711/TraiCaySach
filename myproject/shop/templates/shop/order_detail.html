{% extends "shop/base.html" %}
{% load static %}
{% block title %}Chi tiết đơn hàng{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{% url 'shop:my_orders_page' %}" class="btn btn-sm btn-outline-secondary">← Quay lại danh sách</a>

    <div class="d-flex gap-2">
      {% if order.trang_thai == 'cho_xu_ly' %}
  <button id="btn-cancel" class="btn btn-sm btn-danger">Hủy đơn</button>
{% endif %}
    </div>
  </div>

  <div class="card shadow-sm border-0 rounded-4 p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
      <div>
        <h4 class="text-success mb-2">Chi tiết đơn hàng</h4>
        <div class="text-muted">Mã đơn: <code>{{ order.id|slice:":8" }}</code></div>
      </div>
      <div class="text-end">
        <div class="mb-1">
          <span class="badge rounded-pill status-badge" data-status="{{ order.trang_thai }}">{{ order.trang_thai }}</span>
        </div>
        <div class="small text-muted">
          Ngày tạo: <span class="time" data-iso="{{ order.ngay_tao }}">{{ order.ngay_tao }}</span>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <div class="p-3 rounded-3 border bg-light">
          <div class="small text-muted">Phương thức thanh toán</div>
          <div class="fw-semibold mt-1">{{ order.phuong_thuc_thanh_toan|upper }}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="p-3 rounded-3 border bg-light">
          <div class="small text-muted">Tổng tiền</div>
          <div class="fw-bold mt-1 h5 mb-0">
            <span class="money" data-v="{{ order.tong_tien }}">{{ order.tong_tien }}</span> đ
          </div>
        </div>
      </div>
    </div>

    {% if order.nguoi_dat %}
    <div class="p-3 rounded-3 border mb-3">
      <div class="small text-muted">Thông tin đặt hàng</div>
      <div class="row mt-1">
        <div class="col-md-6">
          <div><strong>Họ tên:</strong> {{ order.nguoi_dat.ten|default:"—" }}</div>
          {% if order.nguoi_dat.ghi_chu %}
          <div class="mt-2"><strong>Ghi chú:</strong> {{ order.nguoi_dat.ghi_chu }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <div><strong>SĐT:</strong> {{ order.nguoi_dat.sdt|default:"—" }}</div>
          <div><strong>Địa chỉ:</strong> {{ order.nguoi_dat.dia_chi|default:"—" }}</div>
        </div>
      </div>
    </div>
    {% endif %}

    <h6 class="text-secondary mb-2">Danh sách sản phẩm</h6>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>Tên sản phẩm</th>
            <th class="text-center" style="width:110px">Số lượng</th>
            <th class="text-end" style="width:160px">Đơn giá</th>
            <th class="text-end" style="width:180px">Thành tiền</th>
          </tr>
        </thead>
        <tbody>
          {% if order.items %}
            {% for it in order.items %}
            <tr>
              <td>{{ it.san_pham_ten|default:"(Không rõ)" }}</td>
              <td class="text-center">{{ it.so_luong }}</td>
              <td class="text-end"><span class="money" data-v="{{ it.don_gia }}">{{ it.don_gia }}</span> đ</td>
              <td class="text-end"><span class="money" data-v="{{ it.tong_tien }}">{{ it.tong_tien }}</span> đ</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td>{{ order.san_pham_ten|default:"(Không rõ)" }}</td>
              <td class="text-center">{{ order.so_luong|default:1 }}</td>
              <td class="text-end"><span class="money" data-v="{{ order.don_gia|default:0 }}">{{ order.don_gia|default:0 }}</span> đ</td>
              <td class="text-end"><span class="money" data-v="{{ order.tong_tien|default:0 }}">{{ order.tong_tien|default:0 }}</span> đ</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .status-badge { text-transform: none; }
  .st-cho_xu_ly   { background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }
  .st-da_xac_nhan { background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; }
  .st-dang_giao   { background:#f0f9ff; color:#0369a1; border:1px solid #bae6fd; }
  .st-hoan_thanh  { background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; }
  .st-da_huy      { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
  #btn-cancel { border-radius: 999px; }
</style>

<script>
  function vnd(n){ try { return Number(n).toLocaleString('vi-VN'); } catch { return n; } }
  function fmtTime(iso){
    if(!iso) return '—';
    try {
      const d = new Date(iso);
      const dd = d.toLocaleDateString('vi-VN');
      const hh = d.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
      return `${dd} ${hh}`;
    } catch { return iso; }
  }
function mapStatusText(st){
  const m = {
    'cho_xu_ly':'Chờ xử lý',
    'da_xac_nhan':'Đã xác nhận',
    'dang_giao':'Đang giao',
    'hoan_thanh':'Hoàn thành',
    'da_huy':'Đã hủy'
  };
  return m[st]||st;
}

  // helper: gỡ các class st-*
  function removeStatusClasses(el){
    (el.className.match(/\bst-[\w_]+\b/g)||[]).forEach(c=>el.classList.remove(c));
  }

  // Format ngay khi load
  document.querySelectorAll('.money').forEach(el=>el.textContent=vnd(el.dataset.v||el.textContent));
  document.querySelectorAll('.time').forEach(el=>el.textContent=fmtTime(el.dataset.iso||el.textContent));
  document.querySelectorAll('.status-badge').forEach(el=>{
    const st=(el.dataset.status||'').trim();
    el.textContent = mapStatusText(st);
    removeStatusClasses(el);
    el.classList.add('st-'+st);
  });

  // ⚙️ Hủy đơn
  const cancelBtn = document.getElementById('btn-cancel');
  if (cancelBtn) {
    const CANCEL_URL = `/api/my-orders/{{ order.id }}/cancel/`;
    cancelBtn.addEventListener('click', async () => {
      if (!confirm('Bạn chắc muốn hủy đơn này?')) return;
      try {
        const r = await fetch(CANCEL_URL, {
          method: 'DELETE',
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await r.json().catch(()=>({}));
        if (!r.ok || !data.ok) {
          alert('Hủy thất bại' + (data.error ? `: ${data.error}` : ''));
          return;
        }

        // ✅ Cập nhật UI ngay lập tức, không cần reload
        const badge = document.querySelector('.status-badge');
        if (badge) {
          const newSt = 'da_huy';
          badge.dataset.status = newSt;
          badge.textContent = mapStatusText(newSt);
          removeStatusClasses(badge);
          badge.classList.add('st-'+newSt);
        }
        cancelBtn.style.display = 'none';
        alert('Đã hủy đơn thành công!');
        // Nếu vẫn muốn đồng bộ dữ liệu 100% từ server: location.reload();
      } catch (e) {
        alert('Có lỗi mạng, vui lòng thử lại!');
      }
    });
  }
</script>

{% endblock %}
